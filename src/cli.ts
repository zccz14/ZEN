#!/usr/bin/env node

import { Command } from 'commander';
import { ZenBuilder } from './builder';
import { ZenConfig } from './types';
import * as path from 'path';
import * as fs from 'fs/promises';
import * as fsSync from 'fs';
import * as url from 'url';

// è·å–ç‰ˆæœ¬å· - ä» package.json è¯»å–
// æ³¨æ„ï¼šåœ¨æ„å»ºæ—¶ï¼Œç‰ˆæœ¬å·ä¼šè¢«æ›¿æ¢ä¸ºå½“å‰ package.json ä¸­çš„ç‰ˆæœ¬
function getVersion(): string {
  return '0.1.2'; // è¿™ä¸ªå€¼ä¼šåœ¨æ„å»ºæ—¶è¢«æ›¿æ¢
}

const program = new Command();

program
  .name('zengen')
  .description('ZEN - A minimalist Markdown documentation site builder')
  .version(getVersion());

// æ„å»ºå‘½ä»¤
program
  .command('build')
  .description('Build documentation site from Markdown files in current directory')
  .option('-t, --template <file>', 'Custom template file')
  .option('-w, --watch', 'Watch for changes and rebuild automatically')
  .option('-s, --serve', 'Start HTTP server for preview (requires --watch)')
  .option('-p, --port <number>', 'HTTP server port', '3000')
  .option('--host <host>', 'HTTP server host', 'localhost')
  .option('-v, --verbose', 'Show detailed output')
  .option('-c, --config <file>', 'Configuration file')
  .option('--base-url <url>', 'Base URL for generated links (e.g., https://example.com/docs)')
  .option('--clean', 'Clean output directory before building')
  .action(async (options) => {
    try {
      // åŠ è½½é…ç½®æ–‡ä»¶
      let config: ZenConfig = {};
      if (options.config) {
        try {
          const configPath = path.resolve(options.config);
          const configContent = await fs.readFile(configPath, 'utf-8');
          config = JSON.parse(configContent);
        } catch (error) {
          console.error(`âŒ Failed to load config file:`, error);
          process.exit(1);
        }
      }

      // å¼ºåˆ¶ä½¿ç”¨å½“å‰ç›®å½•ä½œä¸º src ç›®å½•ï¼Œè¾“å‡ºåˆ° .zen/dist ç›®å½•
      const currentDir = process.cwd();
      const outDir = path.join(currentDir, '.zen', 'dist');

      // åˆå¹¶å‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®
      const buildOptions = {
        srcDir: currentDir,
        outDir: outDir,
        template: options.template ? path.resolve(options.template) : undefined,
        watch: options.watch,
        serve: options.serve,
        port: parseInt(options.port, 10),
        host: options.host,
        verbose: options.verbose,
        baseUrl: options.baseUrl || config.baseUrl
      };


      const builder = new ZenBuilder(config);

      // éªŒè¯é…ç½®
      const errors = builder.validateConfig(config);
      if (errors.length > 0) {
        console.error('âŒ Configuration errors:');
        errors.forEach(error => console.error(`  - ${error}`));
        process.exit(1);
      }

      // è­¦å‘Š --serve é€‰é¡¹éœ€è¦ --watch é€‰é¡¹
      if (options.serve && !options.watch) {
        console.warn('âš ï¸ Warning: --serve option requires --watch option, ignoring --serve');
        buildOptions.serve = false;
      }

      // æ¸…ç†è¾“å‡ºç›®å½•
      if (options.clean) {
        await builder.clean(buildOptions.outDir);
      }

      // æ„å»ºæˆ–ç›‘å¬
      if (options.watch) {
        await builder.watch(buildOptions);
      } else {
        await builder.build(buildOptions);
      }
    } catch (error) {
      console.error('âŒ Build failed:', error);
      process.exit(1);
    }
  });

// æ¸…ç†å‘½ä»¤
program
  .command('clean')
  .description('Clean .zen/dist output directory')
  .action(async () => {
    try {
      const builder = new ZenBuilder();
      const currentDir = process.cwd();
      const outDir = path.join(currentDir, '.zen', 'dist');
      await builder.clean(outDir);
    } catch (error) {
      console.error('âŒ Clean failed:', error);
      process.exit(1);
    }
  });

// åˆå§‹åŒ–å‘½ä»¤
program
  .command('init')
  .description('Initialize a new ZEN project')
  .option('-d, --dir <directory>', 'Target directory', '.')
  .action(async (options) => {
    try {
      const targetDir = path.resolve(options.dir);

      // åˆ›å»ºç›®å½•ç»“æ„
      await fs.mkdir(path.join(targetDir, 'static'), { recursive: true });

      // åˆ›å»ºç¤ºä¾‹æ–‡æ¡£
      const exampleDoc = `# Welcome to ZEN

This is an example documentation page generated by ZEN.

## Getting Started

1. Write your documentation in Markdown format in current directory
2. Run \`zengen build\`
3. Open the generated HTML files in your browser at .zen/dist

## Features

- **Minimal configuration**: Focus on writing, not configuration
- **Smart navigation**: Automatic navigation generation
- **Beautiful templates**: Clean, responsive design
- **Code highlighting**: Syntax highlighting for code blocks

## Example Code

\`\`\`javascript
// This is a JavaScript example
console.log('Hello ZEN!');
\`\`\`

---

*Happy documenting!*`;

      await fs.writeFile(
        path.join(targetDir, 'index.md'),
        exampleDoc,
        'utf-8'
      );

      // åˆ›å»ºé…ç½®æ–‡ä»¶
      const config = {
        template: undefined,
        i18n: {
          sourceLang: 'en-US',
          targetLangs: ['zh-CN', 'ja-JP']
        }
      };

      await fs.writeFile(
        path.join(targetDir, 'zen.config.json'),
        JSON.stringify(config, null, 2),
        'utf-8'
      );

      // åˆ›å»º package.json è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      const packageJsonPath = path.join(targetDir, 'package.json');
      try {
        const packageJson = JSON.parse(await fs.readFile(packageJsonPath, 'utf-8'));

        if (!packageJson.scripts) {
          packageJson.scripts = {};
        }

        packageJson.scripts.build = 'zengen build';
        packageJson.scripts['build:watch'] = 'zengen build --watch';
        packageJson.scripts['build:serve'] = 'zengen build --watch --serve';
        packageJson.scripts.clean = 'zengen clean';

        await fs.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2), 'utf-8');
      } catch (error) {
        // package.json ä¸å­˜åœ¨ï¼Œåˆ›å»ºç®€å•çš„ç‰ˆæœ¬
        const simplePackageJson = {
          name: 'zen-docs',
          version: '1.0.0',
          scripts: {
            build: 'zengen build',
            'build:watch': 'zengen build --watch',
            'build:serve': 'zengen build --watch --serve',
            clean: 'zengen clean'
          }
        };

        await fs.writeFile(
          packageJsonPath,
          JSON.stringify(simplePackageJson, null, 2),
          'utf-8'
        );
      }

      console.log(`
ğŸ‰ ZEN project initialized successfully!

Next steps:
1. Add your Markdown files to the current directory
2. Run 'npm run build' to generate the site (output will be in .zen/dist)
3. Run 'npm run build:watch' for development with auto-reload
4. Run 'npm run build:serve' for development with auto-reload and HTTP server

Project structure:
${targetDir}/
â”œâ”€â”€ index.md        # Example document (in current directory)
â”œâ”€â”€ static/         # Static assets (images, CSS, JS)
â”œâ”€â”€ zen.config.json # Configuration file
â””â”€â”€ package.json    # npm scripts

For more information, visit: https://github.com/yourusername/zen
      `);
    } catch (error) {
      console.error('âŒ Initialization failed:', error);
      process.exit(1);
    }
  });

// ä¿¡æ¯å‘½ä»¤
program
  .command('info')
  .description('Show information about ZEN')
  .action(() => {
    console.log(`
ğŸ¤– ZEN - A minimalist Markdown documentation site builder

Version: 0.1.0
Description: Build beautiful documentation sites from Markdown files

Features:
  â€¢ Minimal configuration required
  â€¢ Smart navigation generation
  â€¢ Beautiful, responsive templates
  â€¢ Code syntax highlighting
  â€¢ Watch mode for development
  â€¢ Sitemap generation
  â€¢ Static asset support

Commands:
  build     Build documentation site
  clean     Clean output directory
  init      Initialize new project
  info      Show this information

Examples:
  $ zengen build
  $ zengen build --watch
  $ zengen build --watch --serve
  $ zengen build --watch --serve --port 8080
  $ zengen init --dir ./my-docs
  $ zengen clean

For more help, run: zengen --help
    `);
  });


// é”™è¯¯å¤„ç†
program.showHelpAfterError();
program.showSuggestionAfterError();

// è§£æå‘½ä»¤è¡Œå‚æ•°
program.parse(process.argv);

// å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºå¸®åŠ©
if (process.argv.length <= 2) {
  program.help();
}